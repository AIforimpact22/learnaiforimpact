{% extends "base.html" %}
{% block title %}Learn ¬∑ {{ course.title }}{% endblock %}

{% block content %}
<style>
  /* --- Small, local styles --- */
  .quiz-wrap fieldset{border:0;margin:0 0 18px;padding:0}
  .quiz-wrap legend{font-weight:600;margin-bottom:10px}
  .choice{display:block;position:relative;border:1px solid #e5e7eb;border-radius:10px;padding:12px 14px;margin:8px 0;cursor:pointer;transition:border-color .15s, box-shadow .15s, background .15s}
  .choice:hover{border-color:#c7cad1;box-shadow:0 1px 0 rgba(0,0,0,.02)}
  .choice input{position:absolute;inset:0;opacity:0;cursor:pointer}
  .choice.selected{border-color:#111827;background:#1118270a}
  .choice .opt-index{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:999px;border:1px solid #d1d5db;margin-right:10px;font-size:12px}
  .choice.selected .opt-index{border-color:#111827}
  .quiz-note{color:#6b7280;font-size:12px;margin-top:8px}
  .exam-link{display:flex;align-items:center;gap:8px}
  .exam-chip{font-size:11px;line-height:1;border:1px solid #d1d5db;border-radius:999px;padding:4px 8px;color:#374151;background:#f9fafb}
  .exam-chip.ok{border-color:#10b981;color:#065f46;background:#ecfdf5}
  .exam-chip.warn{border-color:#f59e0b;color:#92400e;background:#fffbeb}
  .exam-chip.muted{opacity:.7}
  .video-frame video{width:100%;height:auto;border-radius:8px}

  /* Conversation */
  .conversation {border:1px solid #e5e7eb;border-radius:10px;padding:16px;margin-top:24px;background:#fafafa}
  .conversation .row {display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
  .conversation textarea {width:100%;resize:vertical}
  .btn.small {padding:6px 10px;font-size:12px}

  /* Tag selector */
  .tag-grid{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 10px}
  .tag-btn{border:1px solid #d1d5db;border-radius:999px;background:#fff;padding:6px 10px;cursor:pointer}
  .tag-btn.active{background:#111827;color:#fff;border-color:#111827}
  .tag-btn.is-disabled{opacity:.6;cursor:not-allowed}
  .conversation-form button.is-disabled{opacity:.6;cursor:not-allowed}
  .conversation-form textarea:disabled{background:#f3f4f6}

  /* Feed */
  .conv-feed{margin-top:16px}
  .conv-item{border:1px solid #e5e7eb;border-radius:8px;padding:10px;margin:10px 0;background:#fff}
  .conv-item .meta{font-size:12px;color:#6b7280;margin-bottom:6px}
  .chip{display:inline-block;border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;font-size:11px;margin-right:6px;background:#f9fafb}
</style>

<div class="learn-layout">
  <aside class="learn-sidebar">
    <div class="sidebar-inner">
      {% set exam_status_map = exam_statuses | default({}) %}

      {% if registration %}
        <div class="student-card">
          <div class="student-name">{{ learner_name or registration.user_email }}</div>
          <div class="student-email muted small">{{ registration.user_email }}</div>
          {% if registration.phone %}<div class="student-phone small">{{ registration.phone }}</div>{% endif %}
          {% if registration.course_session_code %}<div class="student-session small muted">Session: {{ registration.course_session_code }}</div>{% endif %}
        </div>
      {% endif %}

      <a class="back" href="{{ bp('/course/' ~ course.id ~ '-' ~ course.slug) }}">‚Üê Back to course</a>
      <h2 class="sidebar-title">{{ course.title }}</h2>

      <ol class="sidebar-sections">
        {% for s in sections %}
          {% set week_n = loop.index %}
          {% set is_conv_current = conversation_mode and (conversation_week == week_n) %}
          <li>
            <div class="section-title">{{ s.title or ('Section ' ~ loop.index) }}</div>
            <ul class="sidebar-lessons">

              {# Lessons #}
              {% for l in s.lessons or [] %}
                {% set uid = l.lesson_uid|string %}
                {% set is_current = (not conversation_mode) and (uid == current_lesson_uid|string) %}
                {% set idx = lesson_index_by_uid[uid] if lesson_index_by_uid and (uid in lesson_index_by_uid) else None %}
                <li>
                  <a class="lesson-link {% if is_current %}current{% endif %}"
                     data-kind="lesson"
                     data-lesson-uid="{{ uid }}"
                     href="{{ bp('/learn/' ~ course.id ~ '/' ~ uid) }}">{{ l.title or 'Lesson' }}</a>
                </li>
              {% endfor %}

              {% set status = (exam_status_map.get(week_n) or exam_status_map.get(week_n|string)) %}
              {% set status_enabled = status.enabled if status and status.enabled is not none else True %}
              {% set status_state = status.state if status and status.state is not none else 'none' %}
              {% set status_result = status.result if status else None %}
              {% if not status_enabled %}
                {% set chip_text = 'disabled' %}
                {% set chip_class = 'exam-chip muted' %}
              {% elif status_state == 'graded' and status_result and (status_result.score_percent is not none) %}
                {% set chip_text = 'score ' ~ status_result.score_percent ~ '%' %}
                {% set chip_class = 'exam-chip ok' %}
              {% elif status_state == 'started' %}
                {% set chip_text = 'resume' %}
                {% set chip_class = 'exam-chip warn' %}
              {% else %}
                {% set chip_text = 'start' %}
                {% set chip_class = 'exam-chip' %}
              {% endif %}
              {% set conversation_allowed_for_week = status_enabled and (status_state in ['started','graded']) %}

              {# Week Exam (preloaded status) #}
              <li>
                <a class="lesson-link exam-link"
                   data-kind="exam"
                   href="{{ url_for('exam.exam_start_or_resume', course_id=course.id, week_index=week_n) }}"
                   data-week="{{ week_n }}">
                   üìù Week {{ week_n }} Exam
                   <span class="{{ chip_class }}" aria-live="polite">{{ chip_text }}</span>
                </a>
              </li>

              {# Conversation ‚Äì independent entry #}
              <li class="conversation-item" data-week="{{ week_n }}" {% if not (conversation_allowed_for_week or is_conv_current) %}hidden{% endif %}>
                <a class="lesson-link {% if is_conv_current %}current{% endif %}"
                   data-kind="conversation"
                   href="{{ url_for('learn.conversation_page', course_id=course.id, week_index=week_n) }}">
                   üí¨ Conversation
                </a>
              </li>

            </ul>
          </li>
        {% endfor %}
      </ol>
    </div>
  </aside>

  <section class="learn-content">
    <div class="learn-header">
      {% if conversation_mode %}
        <h1>Conversation</h1>
      {% else %}
        <h1 id="lesson-title">{{ lesson.title or 'Lesson' }}</h1>
      {% endif %}
    </div>

    <div class="learn-body" id="lesson-body">
      {% if not conversation_mode %}
        {% include "partials/lesson_body.html" %}

      {% else %}
        {# ---------------------- CONVERSATION PAGE BODY ---------------------- #}
        {% set current_week = conversation_week %}
        {% set conv_status = (exam_status_map.get(current_week) or exam_status_map.get(current_week|string)) %}
        {% set conv_enabled_flag = conv_status.enabled if conv_status and conv_status.enabled is not none else True %}
        {% set conv_allowed_flag = (conversation_allowed if conversation_allowed is defined else (conv_enabled_flag and (conv_status.state in ['started','graded'] if conv_status else False))) %}
        <section class="conversation" id="conv-week-{{ current_week }}"
                 data-week="{{ current_week }}"
                 data-fetch-url="{{ url_for('learn.get_week_feedback', course_id=course.id, week_index=current_week) }}"
                 data-submit-url="{{ url_for('learn.post_week_feedback', course_id=course.id, week_index=current_week) }}"
                 data-next-first-href="{{ conv_next_first_href or '' }}"
                 data-conversation-allowed="{{ 'true' if conv_allowed_flag else 'false' }}">
          <h3 style="margin:0 0 6px">What did you learn this week?</h3>
          <p class="muted small" style="margin:6px 0 10px">Submitting here will unlock the next section.</p>

          <div class="tag-grid" id="tag-grid">
            {% for t in conversation_tags or [] %}
              <button type="button" class="tag-btn" data-value="{{ t }}">{{ t }}</button>
            {% endfor %}
          </div>

          <form class="conversation-form">
            <textarea name="text" rows="4" maxlength="5000" placeholder="Add a short note‚Ä¶ (optional)"></textarea>
            <div class="row">
              <button type="submit" class="btn small">Submit</button>
              <span class="status muted small" aria-live="polite"></span>
            </div>
          </form>

          <div class="conv-feed" id="conv-feed"></div>
        </section>
      {% endif %}
    </div>

    <div class="learn-nav">
      {% if conversation_mode %}
        <div>
          {% if conv_prev_href %}
            <a class="btn ghost" rel="prev" href="{{ conv_prev_href }}">‚Üê Back</a>
          {% else %}
            <span></span>
          {% endif %}
          {% if conv_next_href %}
            <a class="btn" rel="next" id="conv-next-btn" href="{{ conv_next_href }}">Next ‚Üí</a>
          {% else %}
            <span id="conv-next-slot"></span>
          {% endif %}
        </div>
      {% else %}
        {% if prev_uid %}
          <a class="btn ghost" rel="prev" data-role="prev-slot" data-kind="lesson" data-lesson-uid="{{ prev_uid }}" href="{{ bp('/learn/' ~ course.id ~ '/' ~ prev_uid) }}">‚Üê Previous</a>
        {% else %}
          <span data-role="prev-slot"></span>
        {% endif %}
        {% if next_uid %}
          <a class="btn" rel="next" id="next-btn" data-role="next-slot" data-kind="lesson" data-lesson-uid="{{ next_uid }}" href="{{ bp('/learn/' ~ course.id ~ '/' ~ next_uid) }}">Next ‚Üí</a>
        {% else %}
          <a class="btn ghost" data-role="next-slot" href="{{ bp('/course/' ~ course.id ~ '-' ~ course.slug) }}">Back to course</a>
        {% endif %}
      {% endif %}
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  try {
    // Persist last visited lesson on LESSON pages only (not Conversation)
    {% if not conversation_mode %}
      var key = "progress_course_" + {{ course.id|tojson }};
      localStorage.setItem(key, {{ current_lesson_uid|tojson }});
    {% endif %}

    var prefetchedHrefs = new Set();
    function prefetchNavTargets(opts){
      opts = opts || {};
      var hrefs = [];
      var head = document.head || document.getElementsByTagName('head')[0];
      if (!head) return;

      var nextBtn = document.querySelector('a#next-btn[href]') || document.querySelector('.learn-nav a[rel="next"][href]');
      if (nextBtn) hrefs.push(nextBtn.getAttribute('href'));

      var prevBtn = document.querySelector('.learn-nav a[rel="prev"][href]');
      if (prevBtn) hrefs.push(prevBtn.getAttribute('href'));

      if (opts.blockEl) {
        var firstHref = opts.blockEl.getAttribute('data-next-first-href');
        if (firstHref) hrefs.push(firstHref);
      }

      if (Array.isArray(opts.extraHrefs)) {
        hrefs = hrefs.concat(opts.extraHrefs.filter(function(h){ return typeof h === 'string' && h; }));
      }

      hrefs.forEach(function(href){
        if (!href || prefetchedHrefs.has(href)) return;
        prefetchedHrefs.add(href);
        var link = document.createElement('link');
        link.rel = 'prefetch';
        link.href = href;
        head.appendChild(link);
      });
    }

    {% if not conversation_mode %}
    (function(){
      var courseId = {{ course.id|tojson }};
      var courseTitle = {{ course.title|tojson }};
      var initialLessonUid = {{ current_lesson_uid|tojson }};
      var initialLessonTitle = {{ (lesson.title or 'Lesson')|tojson }};
      var initialPrevHref = {{ prev_uid and bp('/learn/' ~ course.id ~ '/' ~ prev_uid)|tojson or 'null' }};
      var initialNextHref = {{ next_uid and bp('/learn/' ~ course.id ~ '/' ~ next_uid)|tojson or 'null' }};
      var courseHomeHref = {{ bp('/course/' ~ course.id ~ '-' ~ course.slug)|tojson }};
      var progressKey = "progress_course_" + courseId;
      var lessonBodyEl = document.getElementById('lesson-body');
      var lessonTitleEl = document.getElementById('lesson-title');
      var sidebarEl = document.querySelector('.learn-sidebar');
      var navEl = document.querySelector('.learn-nav');
      if (!lessonBodyEl || !lessonTitleEl || !sidebarEl || !navEl) {
        prefetchNavTargets();
        return;
      }

      history.replaceState({ lessonUid: initialLessonUid }, '', window.location.href);
      document.title = 'Learn ¬∑ ' + initialLessonTitle + ' ¬∑ ' + courseTitle;

      var prevSlot = navEl.querySelector('[data-role="prev-slot"]');
      var nextSlot = navEl.querySelector('[data-role="next-slot"]');
      var activeRequestId = 0;

      function escapeSelector(value){
        if (window.CSS && typeof window.CSS.escape === 'function') {
          return CSS.escape(value);
        }
        return String(value).replace(/["\\]/g, '\\$&');
      }

      function buildDataUrl(href){
        if (!href) return null;
        try {
          var url = new URL(href, window.location.origin);
          var path = url.pathname || '';
          if (path.length > 1 && path.endsWith('/')) {
            path = path.slice(0, -1);
          }
          url.pathname = path + '/data';
          return url.toString();
        } catch (err) {
          if (href.endsWith('/')) href = href.slice(0, -1);
          return href + '/data';
        }
      }

      function setActiveLesson(lessonUid){
        sidebarEl.querySelectorAll('a.lesson-link.current').forEach(function(link){
          link.classList.remove('current');
        });
        if (!lessonUid) return;
        try {
          var target = sidebarEl.querySelector('a.lesson-link[data-lesson-uid="' + escapeSelector(lessonUid) + '"]');
          if (target) {
            target.classList.add('current');
          }
        } catch (err) {
          // ignore selector errors
        }
      }

      function updateNav(prevUrl, prevUid, nextUrl, nextUid){
        if (prevSlot) {
          var newPrev;
          if (prevUrl && prevUid) {
            newPrev = document.createElement('a');
            newPrev.className = 'btn ghost';
            newPrev.setAttribute('rel', 'prev');
            newPrev.setAttribute('data-role', 'prev-slot');
            newPrev.setAttribute('data-kind', 'lesson');
            newPrev.setAttribute('data-lesson-uid', prevUid);
            newPrev.href = prevUrl;
            newPrev.textContent = '‚Üê Previous';
          } else {
            newPrev = document.createElement('span');
            newPrev.setAttribute('data-role', 'prev-slot');
          }
          prevSlot.replaceWith(newPrev);
          prevSlot = newPrev;
        }

        if (nextSlot) {
          var newNext;
          if (nextUrl && nextUid) {
            newNext = document.createElement('a');
            newNext.className = 'btn';
            newNext.id = 'next-btn';
            newNext.setAttribute('rel', 'next');
            newNext.setAttribute('data-role', 'next-slot');
            newNext.setAttribute('data-kind', 'lesson');
            newNext.setAttribute('data-lesson-uid', nextUid);
            newNext.href = nextUrl;
            newNext.textContent = 'Next ‚Üí';
          } else {
            newNext = document.createElement('a');
            newNext.className = 'btn ghost';
            newNext.setAttribute('data-role', 'next-slot');
            newNext.href = courseHomeHref;
            newNext.textContent = 'Back to course';
          }
          nextSlot.replaceWith(newNext);
          nextSlot = newNext;
        }

        prefetchNavTargets();
      }

      function prefetchForPayload(payload){
        var extras = [];
        if (payload && Array.isArray(payload.prefetch_urls)) {
          extras = extras.concat(payload.prefetch_urls.filter(Boolean));
        }
        if (payload && payload.prev_url) {
          var prevData = buildDataUrl(payload.prev_url);
          if (prevData) extras.push(prevData);
        }
        if (payload && payload.next_url) {
          var nextData = buildDataUrl(payload.next_url);
          if (nextData) extras.push(nextData);
        }
        if (extras.length) {
          prefetchNavTargets({ extraHrefs: extras });
        }
      }

      function beginLoading(){
        if (lessonBodyEl) {
          lessonBodyEl.classList.add('is-loading');
          lessonBodyEl.setAttribute('aria-busy', 'true');
        }
      }

      function finalizeLoading(){
        if (lessonBodyEl) {
          lessonBodyEl.classList.remove('is-loading');
          lessonBodyEl.removeAttribute('aria-busy');
        }
      }

      function renderLesson(payload){
        if (lessonTitleEl) {
          lessonTitleEl.textContent = payload.lesson_title || 'Lesson';
        }
        if (lessonBodyEl) {
          lessonBodyEl.innerHTML = payload.lesson_html || '';
        }
        setActiveLesson(payload.lesson_uid);
        updateNav(payload.prev_url, payload.prev_uid, payload.next_url, payload.next_uid);
        if (payload.lesson_uid) {
          try { localStorage.setItem(progressKey, payload.lesson_uid); } catch (err) {}
        }
        document.title = 'Learn ¬∑ ' + (payload.lesson_title || 'Lesson') + ' ¬∑ ' + courseTitle;
        prefetchForPayload(payload);
      }

      function shouldHandle(event, link){
        if (!link) return false;
        if (link.target && link.target.toLowerCase() === '_blank') return false;
        if (event.metaKey || event.ctrlKey || event.shiftKey || event.altKey) return false;
        return true;
      }

      function loadLesson(href, opts){
        opts = opts || {};
        if (!href) return;
        var dataUrl = buildDataUrl(href);
        if (!dataUrl) {
          window.location.href = href;
          return;
        }
        var requestId = ++activeRequestId;
        beginLoading();
        fetch(dataUrl, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } })
          .then(function(res){
            if (!res.ok) throw new Error('HTTP ' + res.status);
            return res.json();
          })
          .then(function(payload){
            if (requestId !== activeRequestId) return;
            if (!payload || !payload.ok) {
              if (payload && payload.redirect_url) {
                window.location.href = payload.redirect_url;
                return;
              }
              throw new Error('bad-payload');
            }
            renderLesson(payload);
            if (opts.replaceState) {
              history.replaceState({ lessonUid: payload.lesson_uid }, '', payload.page_url || href);
            } else if (opts.pushState !== false) {
              history.pushState({ lessonUid: payload.lesson_uid }, '', payload.page_url || href);
            }
          })
          .catch(function(err){
            if (requestId === activeRequestId) {
              console.error('lesson fetch failed', err);
              window.location.href = href;
            }
          })
          .finally(function(){
            if (requestId === activeRequestId) {
              finalizeLoading();
            }
          });
      }

      sidebarEl.addEventListener('click', function(e){
        var link = e.target.closest('a.lesson-link[data-kind="lesson"]');
        if (!shouldHandle(e, link)) return;
        e.preventDefault();
        loadLesson(link.getAttribute('href'));
      });

      navEl.addEventListener('click', function(e){
        var link = e.target.closest('[data-role="prev-slot"],[data-role="next-slot"]');
        if (!link || link.getAttribute('data-kind') !== 'lesson') return;
        if (!shouldHandle(e, link)) return;
        e.preventDefault();
        loadLesson(link.getAttribute('href'));
      });

      document.addEventListener('keydown', function(e){
        if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable)) return;
        if (e.key === 'ArrowRight') {
          var nextLink = navEl.querySelector('[data-role="next-slot"][data-kind="lesson"]');
          if (nextLink) {
            e.preventDefault();
            loadLesson(nextLink.getAttribute('href'));
          }
        } else if (e.key === 'ArrowLeft') {
          var prevLink = navEl.querySelector('[data-role="prev-slot"][data-kind="lesson"]');
          if (prevLink) {
            e.preventDefault();
            loadLesson(prevLink.getAttribute('href'));
          }
        }
      });

      window.addEventListener('popstate', function(event){
        if (!event.state || !event.state.lessonUid) {
          window.location.href = window.location.href;
          return;
        }
        loadLesson(window.location.href, { pushState: false, replaceState: true });
      });

      var initialExtras = [];
      if (initialPrevHref) {
        initialExtras.push(initialPrevHref);
        var prevData = buildDataUrl(initialPrevHref);
        if (prevData) initialExtras.push(prevData);
      }
      if (initialNextHref) {
        initialExtras.push(initialNextHref);
        var nextData = buildDataUrl(initialNextHref);
        if (nextData) initialExtras.push(nextData);
      }
      if (initialExtras.length) {
        prefetchNavTargets({ extraHrefs: initialExtras });
      } else {
        prefetchNavTargets();
      }
    })();
    {% endif %}

    // ---------------- Conversation helpers ----------------
    function buildFeedItem(it){
      var div = document.createElement('div');
      div.className = 'conv-item';
      var meta = document.createElement('div');
      meta.className = 'meta';
      var who = (it.user_display || it.user_email || 'User');
      var when = it.created_at || '';
      meta.innerHTML = '<strong>'+ who +'</strong> ¬∑ <span>'+ when +'</span>';
      var tagsWrap = document.createElement('div');
      if (Array.isArray(it.tags)) {
        it.tags.forEach(function(t){
          var chip = document.createElement('span');
          chip.className = 'chip';
          chip.textContent = t;
          tagsWrap.appendChild(chip);
        });
      }
      var body = document.createElement('div');
      body.className = 'body';
      body.textContent = it.text || '';
      div.appendChild(meta);
      if (tagsWrap.childNodes.length) div.appendChild(tagsWrap);
      if (body.textContent) div.appendChild(body);
      return div;
    }

    function renderFeed(container, items){
      container.innerHTML = '';
      (items || []).forEach(function(it){
        container.appendChild(buildFeedItem(it));
      });
    }

    function initConversation(blockEl) {
      if (!blockEl || blockEl.__inited) return;
      blockEl.__inited = true;

      var form     = blockEl.querySelector('.conversation-form');
      var statusEl = blockEl.querySelector('.status');
      var fetchUrl = blockEl.getAttribute('data-fetch-url');
      var submitUrl= blockEl.getAttribute('data-submit-url');
      var feed     = blockEl.querySelector('#conv-feed');
      var nextFirstHref = blockEl.getAttribute('data-next-first-href');

      var controls = Array.prototype.slice.call(blockEl.querySelectorAll('.conversation-form button, .conversation-form textarea, .tag-btn'));
      var lockedMsg = 'Complete the exam to unlock this conversation.';

      prefetchNavTargets({ blockEl: blockEl });

      function setEnabled(enabled){
        var disabled = !enabled;
        controls.forEach(function(el){
          if ('disabled' in el) el.disabled = disabled;
          if (disabled) {
            el.classList.add('is-disabled');
          } else {
            el.classList.remove('is-disabled');
          }
        });
        if (statusEl) {
          if (disabled) {
            statusEl.textContent = lockedMsg;
          } else if (statusEl.textContent === lockedMsg) {
            statusEl.textContent = '';
          }
        }
      }

      blockEl.__setConversationEnabled = setEnabled;
      var defaultAllowedAttr = blockEl.getAttribute('data-conversation-allowed');
      var defaultAllowed = (defaultAllowedAttr === 'true' || defaultAllowedAttr === '1');
      setEnabled(defaultAllowed);

      // Tag buttons
      var selected = new Set();
      blockEl.querySelectorAll('.tag-btn').forEach(function(btn){
        btn.addEventListener('click', function(){
          var v = btn.getAttribute('data-value');
          if (selected.has(v)) { selected.delete(v); btn.classList.remove('active'); }
          else { selected.add(v); btn.classList.add('active'); }
        });
      });

      var latestFeedRequestId = 0;

      function loadFeed(){
        if (!fetchUrl) return Promise.resolve();
        var requestId = ++latestFeedRequestId;
        return fetch(fetchUrl, {credentials: 'same-origin', headers: {'Accept':'application/json'}})
          .then(function(r){ return r.ok ? r.json() : Promise.reject(new Error('HTTP '+r.status)); })
          .then(function(j){
            if (requestId !== latestFeedRequestId) return;
            if (j && j.ok) renderFeed(feed, j.items || []);
          })
          .catch(function(err){
            if (requestId === latestFeedRequestId) {
              console.error('loadFeed failed', err);
            }
          });
      }

      // Initial load
      loadFeed();

      form.addEventListener('submit', function(e){
        e.preventDefault();
        var textArea  = form.querySelector('textarea[name="text"]');
        var tags = Array.from(selected);
        var payload = { tags: tags, text: textArea ? (textArea.value || '') : '' };
        if (statusEl) statusEl.textContent = 'Saving‚Ä¶';
        fetch(submitUrl, {
          method: 'POST',
          credentials: 'same-origin',
          headers: {'Content-Type': 'application/json', 'Accept':'application/json'},
          body: JSON.stringify(payload)
        })
        .then(function(r){ return r.ok ? r.json() : Promise.reject(new Error('HTTP '+r.status)); })
        .then(function(j){
            if (j && j.ok) {
              if (statusEl) statusEl.textContent = 'Saved! Next section unlocked.';
              // Clear selections + text
              selected.clear();
              blockEl.querySelectorAll('.tag-btn.active').forEach(function(b){ b.classList.remove('active'); });
              if (textArea) textArea.value = '';
            if (j.item) {
              var newItem = buildFeedItem(j.item);
              if (newItem) {
                if (feed.firstChild) feed.insertBefore(newItem, feed.firstChild);
                else feed.appendChild(newItem);
              }
            }
            loadFeed();

            // Reveal "Next ‚Üí" button inline without reload
            var slot = document.getElementById('conv-next-slot');
            if (slot && nextFirstHref) {
              var a = document.createElement('a');
              a.className = 'btn';
              a.setAttribute('rel', 'next');
              a.id = 'conv-next-btn';
              a.href = nextFirstHref;
              a.textContent = 'Next ‚Üí';
              slot.parentNode.replaceChild(a, slot);
              prefetchNavTargets({ extraHrefs: [nextFirstHref] });
            }
          } else {
            throw new Error('bad-json');
          }
        })
        .catch(function(err){
          console.error('submit failed', err);
          if (statusEl) statusEl.textContent = 'Failed to save';
        });
      });
    }

    // If current page is Conversation, ensure it initializes on its own
    {% if conversation_mode %}
      (function(){
        var inline = document.getElementById('conv-week-{{ conversation_week }}');
        if (!inline) return;
        initConversation(inline);
      })();
    {% endif %}

  } catch(e){ console.error(e); }
})();
</script>
{% endblock %}
